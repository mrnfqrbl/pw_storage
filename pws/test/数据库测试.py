# 文件路径: tests/数据库测试.py
# 中文说明:
# 数据库操作单元测试示例
# 使用数据库总线适配器事件接口进行完整测试，包括数据集、文档、索引操作

import random
from pws.test import 应用实例

class 数据库测试:
    def __init__(self, 应用实例: 应用实例):
        self.应用实例 = 应用实例
        self.总线 = self.应用实例.事件总线实例
        self.测试数据集名称 = f"测试数据集{random.randint(0,1000)}"
        self.测试记录 = {"字段1": "值1", "字段2": 123}
        self.总线.发布日志("debug", f"开始测试，数据集名称: {self.测试数据集名称}")

    def 开始测试(self):
        print("开始数据库测试...")
        self.测试创建数据集()
        self.测试插入记录()
        self.测试批量插入()
        self.测试查询文档()
        self.测试查询单条()
        self.测试更新记录()
        self.测试删除记录()
        self.测试创建索引()
        self.测试删除索引()
        self.测试删除数据集()
        print("数据库测试完成。")

    # ---------------- 数据集操作 ----------------
    def 测试创建数据集(self):
        返回 = self.总线.发布("db.创建数据集", {"数据集名称": self.测试数据集名称})
        assert 返回, "创建数据集失败"
        self.总线.发布日志("debug", f"创建数据集返回: {返回.转字典()}")

    def 测试删除数据集(self):
        返回 = self.总线.发布("db.删除数据集", {"数据集名称": self.测试数据集名称})
        assert 返回, "删除数据集失败"
        self.总线.发布日志("debug", f"删除数据集返回: {返回.转字典()}")

    # ---------------- 文档操作 ----------------
    def 测试插入记录(self):
        返回 = self.总线.发布("db.插入文档", {
            "数据集名称": self.测试数据集名称,
            "文档数据": self.测试记录
        })
        assert 返回, "插入记录失败"
        self.总线.发布日志("debug", f"插入记录返回: {返回.转字典()}")

    def 测试批量插入(self):
        文档列表 = [{"字段1": f"值{i}", "字段2": i} for i in range(3)]
        for 文档 in 文档列表:
            返回 = self.总线.发布("db.插入文档", {
                "数据集名称": self.测试数据集名称,
                "文档数据": 文档
            })
            assert 返回, "批量插入失败"
            self.总线.发布日志("debug", f"批量插入记录返回: {返回.转字典()}")

    def 测试查询文档(self):
        返回 = self.总线.发布("db.查询文档", {
            "数据集名称": self.测试数据集名称,
            "查询条件": {"字段2": 123}
        })
        assert 返回, "查询文档失败"
        self.总线.发布日志("debug", f"查询文档返回: {返回.转字典()}")

    def 测试查询单条(self):
        返回 = self.总线.发布("db.查询文档", {
            "数据集名称": self.测试数据集名称,
            "查询条件": {"字段1": "值1"},
            "限制": 1
        })
        assert 返回, "查询单条记录失败"
        self.总线.发布日志("debug", f"查询单条记录返回: {返回.转字典()}")

    def 测试更新记录(self):
        更新内容 = {"字段2": 456}
        返回 = self.总线.发布("db.更新文档", {
            "数据集名称": self.测试数据集名称,
            "查询条件": {"字段1": "值1"},
            "更新内容": 更新内容
        })
        assert 返回, "更新记录失败"
        self.总线.发布日志("debug", f"更新记录返回: {返回.转字典()}")

    def 测试删除记录(self):
        返回 = self.总线.发布("db.删除文档", {
            "数据集名称": self.测试数据集名称,
            "查询条件": {"字段1": "值1"}
        })
        assert 返回, "删除记录失败"
        self.总线.发布日志("debug", f"删除记录返回: {返回.转字典()}")

    # ---------------- 索引操作 ----------------
    def 测试创建索引(self):
        返回 = self.总线.发布("db.创建索引", {
            "数据集名称": self.测试数据集名称,
            "索引字段": ["字段1"],
            "唯一": False
        })
        assert 返回, "创建索引失败"
        self.总线.发布日志("debug", f"创建索引返回: {返回.转字典()}")

    def 测试删除索引(self):
        返回 = self.总线.发布("db.删除索引", {
            "数据集名称": self.测试数据集名称,
            "索引名称": "字段1_1"
        })
        assert 返回, "删除索引失败"
        self.总线.发布日志("debug", f"删除索引返回: {返回.转字典()}")

# ===== 示例运行 =====
if __name__ == "__main__":
    测试实例 = 数据库测试(应用实例)
    测试实例.开始测试()
